# 技术经验总结：文件夹导航功能

> 日期：2024-12-24  
> 项目：FileFlow

## 问题背景

实现文件夹导航功能时，需要在应用内浏览嵌套文件夹，类似 Finder 的体验。

---

## 遇到的问题及解决方案

### 1. 侧边栏切换不更新内容

**问题**：点击侧边栏切换子文件夹后，内容区不刷新。

**原因**：缺少 `onChange` 监听器。

**解决**：
```swift
.onChange(of: selectedSubcategory) { _, _ in
    Task {
        browsingPath = []  // 重置浏览路径
        await loadData()   // 重新加载数据
    }
}
```

---

### 2. 文件夹重复显示

**问题**：同一个文件夹在列表中出现两次。

**原因**：
- `childFolders` 从文件系统扫描得到
- `filteredFiles` 从数据库查询得到
- 目录被误存为 `ManagedFile` 记录

**解决**：
```swift
// 过滤掉实际是目录的项目
result = result.filter { file in
    var isDir: ObjCBool = false
    let exists = FileManager.default.fileExists(atPath: file.newPath, isDirectory: &isDir)
    return exists && !isDir.boolValue
}

// 过滤掉已在文件夹列表中的项目
let folderNames = Set(childFolders)
result = result.filter { file in
    !folderNames.contains(fileName)
}
```

---

### 3. 子文件夹内文件不显示

**问题**：双击进入子文件夹后，里面的文件不显示。

**原因**：数据库查询基于 `subcategory` 字段，不支持深层路径。

**解决**：采用**双数据源**架构：

```swift
// 状态
@State private var filesAtPath: [URL] = []  // 文件系统文件

// 加载时扫描文件系统
childFolders = await scanChildFolders()
filesAtPath = await scanFilesAtPath()

// 显示逻辑
if !browsingPath.isEmpty {
    // 深层：显示文件系统扫描的文件
    ForEach(filesAtPath, id: \.absoluteString) { url in
        FilesystemFileRow(url: url)
    }
} else {
    // 顶层：显示数据库文件
    ForEach(filteredFiles) { file in
        FileListRow(file: file)
    }
}
```

---

### 4. 双击手势不生效

**问题**：`onTapGesture(count: 2)` 不触发。

**原因**：与 `onTapGesture(count: 1)` 冲突，空的单击处理阻断了双击。

**解决**：使用 `TapGesture` API：
```swift
.gesture(
    TapGesture(count: 2)
        .onEnded {
            browsingPath.append(folderName)
            Task { await loadData() }
        }
)
```

---

### 5. 编译器超时

**问题**：`the compiler is unable to type-check this expression in reasonable time`

**原因**：`body` 内嵌套过深，表达式过于复杂。

**解决**：提取为独立的计算属性：
```swift
var body: some View {
    VStack {
        breadcrumbNavigationView  // 提取
        sortingToolbarView        // 提取
        fileListWithFoldersView   // 提取
    }
}

private var breadcrumbNavigationView: some View { ... }
private var sortingToolbarView: some View { ... }
private var fileListWithFoldersView: some View { ... }
```

---

### 6. 类型不匹配

**问题**：`static property 'blue' requires the types 'HierarchicalShapeStyle' and 'Color' be equivalent`

**原因**：三元运算符两边类型不一致（`.primary` vs `.blue`）。

**解决**：显式指定类型：
```swift
// 错误
.foregroundStyle(condition ? .primary : .blue)

// 正确
.foregroundStyle(condition ? Color.primary : Color.blue)
```

---

## 设计原则

### 数据库 vs 文件系统

| 场景 | 使用数据库 | 使用文件系统 |
|------|-----------|-------------|
| 显示元数据（标签、分类） | ✅ | ❌ |
| 浏览深层目录结构 | ❌ | ✅ |
| 显示未导入的文件 | ❌ | ✅ |
| 搜索和过滤 | ✅ | 有限 |

### 最佳实践

1. **添加 `onChange` 监听关键状态变化**
2. **UI 复杂时提取子视图/计算属性**
3. **双数据源时注意去重**
4. **手势使用 `TapGesture` API 更可控**
5. **三元运算符确保两边类型一致**

---

## 架构图

```
┌─────────────────────────────────────────────────┐
│                  CategoryView                   │
├─────────────────────────────────────────────────┤
│  selectedSubcategory  ──onChange──> loadData()  │
│  browsingPath         ──onChange──> loadData()  │
├─────────────────────────────────────────────────┤
│  loadData()                                     │
│    ├── database.getFiles()  ──> files           │
│    ├── scanChildFolders()   ──> childFolders    │
│    └── scanFilesAtPath()    ──> filesAtPath     │
├─────────────────────────────────────────────────┤
│  显示逻辑                                        │
│    browsingPath.isEmpty ?                       │
│      ├── true:  filteredFiles (数据库)          │
│      └── false: filesAtPath (文件系统)          │
└─────────────────────────────────────────────────┘
```
